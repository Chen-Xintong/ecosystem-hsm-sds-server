apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  name: istio
spec:
  # profile: minimal
  # hub: "istio"
  # tag: "latest"
  values:
    global:
      imagePullPolicy: IfNotPresent
    sidecarInjectorWebhook:
      templates:
        custom: |
          spec:
            containers:
            - name: testsds
              image: sds-server/sds-server:latest
              imagePullPolicy: IfNotPresent
              lifecycle:
                postStart:
                  exec:
                    command: 
                    - sh
                    - "-c"
                    - |-
                      ./copylib.sh && /sds/sds-server wait
              env:
              - name: MOCKSDS
                value: mock-sds-server
              volumeMounts:
              - name: sds-server
                mountPath: /tmp/testsocket1
              - name: workload-socket
                mountPath: /var/run/secrets/workload-spiffe-uds
              - name: credential-socket
                mountPath: /var/run/secrets/credential-uds
              - name: sgx-libraries
                mountPath: /usr/local/libsgx
            - name: istio-proxy
              volumeMounts:
              - name: sds-server
                mountPath: /tmp/testsocket2
              - name: credential-socket
                mountPath: /var/run/secrets/credential-uds
              - name: sgx-libraries
                mountPath: /usr/local/libsgx
              env:
              - name: GREETING
                value: hello-world
            volumes:
            - name: sds-server
              hostPath: 
                path: /tmp/testsocket
                type: DirectoryOrCreate
            - emptyDir:
              name: workload-socket
            - emptyDir:
              name: credential-socket
            - emptyDir:
              name: sgx-libraries

